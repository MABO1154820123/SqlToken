name: Scheduled Request

on:
  schedule:
    - cron: '*/4 * * * *'  # 每 4 分钟执行一次
  workflow_dispatch:  # 允许手动触发

jobs:
  send-request:
    runs-on: ubuntu-latest
    # 添加权限，确保工作流可以设置环境变量
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Send request and save response
        id: get_token  # 添加ID以引用此步骤
        run: python send_request.py

      - name: Verify SQL_TOKEN environment variable
        if: success()  # 只有在前一步成功时才执行
        run: |
          echo "验证SQL_TOKEN环境变量是否可用: ${{ env.SQL_TOKEN }}"
          # 检查环境变量是否已设置
          if [ -z "${{ env.SQL_TOKEN }}" ]; then
            echo "SQL_TOKEN环境变量未设置"
            exit 1
          else
            echo "SQL_TOKEN环境变量已成功设置"
            # 出于安全考虑，只打印token的前几个字符
            echo "Token前缀: $(echo ${{ env.SQL_TOKEN }} | cut -c1-8)..."
          fi
